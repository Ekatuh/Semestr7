name: Python CI/CD  # Название пайплайна

#Когда запускать пайплайн
on:
  push:                # При команде git push
    branches: [ "main" ]    # Только если изменения в ветке main
  pull_request:         # При создании Pull Request в main
    branches: [ "main" ]
  workflow_dispatch:     # Позволяет вручную запустить через интерфейс GitHub Actions

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      #Получаем код из репозитория
      - name: Checkout repository
        uses: actions/checkout@v4

      #Устанавливаем Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      #Устанавливаем зависимости
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest flake8 coverage bandit
      #Запуск тестов для проверки корректности
      - name: Run tests
        run: |
          echo "Запуск тестов..."
          pytest 
          
      #Проверка стиля кода (выполнение линтинга)
      - name: Run flake8 linting
        run: |
          echo "Проверка кода с flake8..."
          flake8 .
      
      #Проверка покрытия тестами
      - name: Run tests with coverage
        run: |
          echo "Проверка покрытия тестами..."
          coverage run -m pytest
          coverage report -m

      #Проверка безопасности
      - name: Run security check with Bandit
        run: |
          echo "Проверка безопасности..."
          bandit -r .

      #Отправка уведомления в Telegram
      - name: Send Telegram notification
        if: always()   # Выполняется всегда — даже при ошибках
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="Пайплайн успешно завершён!"
          else
            STATUS="Пайплайн завершился с ошибкой!"
          fi
          
          MESSAGE="${STATUS}"
          
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MESSAGE"