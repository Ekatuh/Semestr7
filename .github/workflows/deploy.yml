name: Python CI/CD  # –ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞

#–ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω
on:
  push:                # –ü—Ä–∏ –∫–æ–º–∞–Ω–¥–µ git push
    branches: [ "main" ]    # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≤–µ—Ç–∫–µ main
  pull_request:         # –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Pull Request –≤ main
    branches: [ "main" ]
  workflow_dispatch:     # –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—Ä—É—á–Ω—É—é –∑–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å GitHub Actions

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      #–ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout repository
        uses: actions/checkout@v4

      #–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      #–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest flake8 coverage bandit
      #–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏
      - name: Run tests
        run: |
          echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
          pytest 
          
      #–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞ (–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ª–∏–Ω—Ç–∏–Ω–≥–∞)
      - name: Run flake8 linting
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ —Å flake8..."
          flake8 .
      
      #–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ—Å—Ç–∞–º–∏
      - name: Run tests with coverage
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ—Å—Ç–∞–º–∏..."
          coverage run -m pytest
          coverage report -m

      #–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      - name: Run security check with Bandit
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏..."
          bandit -r .

      #–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
      - name: Send Telegram notification
        if: always()   # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ ‚Äî –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="–ü–∞–π–ø–ª–∞–π–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
          else
            STATUS="–ü–∞–π–ø–ª–∞–π–Ω –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!"
          fi
          
          MESSAGE="üîî GitHub Actions (${GITHUB_REPOSITORY})\n${STATUS}\n\n–ö–æ–º–º–∏—Ç: ${GITHUB_SHA}\n–ê–≤—Ç–æ—Ä: ${GITHUB_ACTOR}"
          
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MESSAGE"